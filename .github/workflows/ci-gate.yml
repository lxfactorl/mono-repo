name: CI Gate

on:
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: read
  statuses: read

jobs:
  # Path-based filtering to determine which services changed
  filter:
    runs-on: ubuntu-latest
    outputs:
      notification_service: ${{ steps.changes.outputs.notification_service }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          notification_service:
            - 'src/backend/notification-service/**'
            - 'Directory.Build.props'
            - 'global.json'
            - '.github/workflows/backend-notification-service.yml'
            - '.github/workflows/dotnet-ci.yml'

  # Conditional validation for Notification Service
  validate-notification-service:
    needs: filter
    if: needs.filter.outputs.notification_service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json
          dotnet-quality: 'preview'
        
      - name: Restore
        run: dotnet restore
        working-directory: src/backend/notification-service

      - name: Format Check
        run: dotnet format --verify-no-changes --severity warn
        working-directory: src/backend/notification-service

      - name: Build
        run: dotnet build --no-restore /p:TreatWarningsAsErrors=true
        working-directory: src/backend/notification-service

      - name: Security Audit
        run: |
          OUTPUT=$(dotnet list package --vulnerable --include-transitive 2>&1)
          echo "$OUTPUT"
          if echo "$OUTPUT" | grep -q "has the following vulnerable packages"; then
            echo "::error::Vulnerable packages detected"
            exit 1
          fi
        working-directory: src/backend/notification-service

      - name: Test
        run: dotnet test --no-build --collect:"XPlat Code Coverage" --results-directory ./coverage
        working-directory: src/backend/notification-service

      - name: Coverage Gate
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator -reports:./coverage/**/coverage.cobertura.xml -targetdir:./coverage/report -reporttypes:TextSummary
          cat ./coverage/report/Summary.txt
          COVERAGE=$(grep "Line coverage:" ./coverage/report/Summary.txt | grep -oP '\d+\.?\d*%' | head -1 | tr -d '%')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below 80% threshold"
            exit 1
          fi
        working-directory: src/backend/notification-service

  # THE GATEKEEPER - This is the ONLY required check
  # It waits for all other jobs and reports their collective status
  gatekeeper:
    runs-on: ubuntu-latest
    needs: [filter, validate-notification-service]
    if: always()
    steps:
      - name: Check All Jobs
        run: |
          echo "Filter: ${{ needs.filter.result }}"
          echo "Notification Service: ${{ needs.validate-notification-service.result }}"
          
          # Filter must succeed
          if [ "${{ needs.filter.result }}" != "success" ]; then
            echo "::error::Filter job failed"
            exit 1
          fi
          
          # Validate-notification-service can be skipped or success, but not failure/cancelled
          NS_RESULT="${{ needs.validate-notification-service.result }}"
          if [ "$NS_RESULT" == "failure" ] || [ "$NS_RESULT" == "cancelled" ]; then
            echo "::error::Notification Service validation failed"
            exit 1
          fi
          
          echo "::notice::âœ… All quality gates passed - PR is ready to merge"
