name: Monorepo CI Gate

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  # 1. PATH FILTERS
  # Detect which services have changed in this PR/Commit
  filter:
    runs-on: ubuntu-latest
    outputs:
      notification_service: ${{ steps.changes.outputs.notification_service }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: changes
      with:
        filters: |
          notification_service:
            - 'src/backend/notification-service/**'
            - 'Directory.Build.props'
            - 'global.json'
            - '.github/workflows/backend-notification-service.yml'
            - '.github/workflows/dotnet-ci.yml'

  # 2. SERVICE VALIDATION (Conditional)
  # Calls the reusable workflow for each service triggers by the filter
  check-notification-service:
    needs: filter
    if: ${{ needs.filter.outputs.notification_service == 'true' }}
    uses: ./.github/workflows/backend-notification-service.yml

  # 3. THE MONOREPO GATE (Required Check)
  # This job ALWAYS runs. It depends on the conditional jobs.
  # If a conditional job was skipped, this job still succeeds (as long as dependencies didn't fail).
  monorepo-gate:
    runs-on: ubuntu-latest
    needs: [check-notification-service]
    # Evaluate: If any dependency FAILED, this fail. If Skipped or Success, this Pass.
    if: always()
    steps:
      - name: Verify Gate
        run: |
          # Check status of 'check-notification-service'
          NS_RESULT="${{ needs.check-notification-service.result }}"
          
          echo "Notification Service Result: $NS_RESULT"
          
          # Logic: If result is 'failure' or 'cancelled', fail the gate.
          # 'skipped' or 'success' is acceptable.
          if [[ "$NS_RESULT" == "failure" || "$NS_RESULT" == "cancelled" ]]; then
            echo "::error::Notification Service verification failed."
            exit 1
          fi
          
          echo "::notice::Monorepo Gate Passed"
